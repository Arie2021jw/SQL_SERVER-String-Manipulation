Exercise #5: Convert delimited lists separated by commas into a list of multiple values that can be passed to the IN clause and used in the WHERE clause.


Solution #1: We use a similar logic applied on previous Exercise #4 to column "DelimitedListCityName", to create a column with delimited lists of City names separated by commas and grouped by country (using column "CountryRegionCode").

Tables used:
1) [AdventureWorks2022].[Person].[Address]
2) [AdventureWorks2022].[Person].[StateProvince]
3) [AdventureWorks2022].[Sales].[SalesTerritory]


Query #1: Retrieving values from column PersonAddress.City (horizontally) in a delimited list by commas, instead of vertically, using subqueries
	+ 6 Subqueries
	+ Cartesian Product
	+ 2 Iterations
	+ Functions: SUBSTRING, CHARINDEX, LEN, STRING_AGG, CONVERT, NVARCHAR(max), CHAR
	+ Window functions: ROW_NUMBER() OVER(ORDER BY )


SELECT AddressLine1
FROM [AdventureWorks2022].[Person].[Address] 
WHERE City IN (
    SELECT SUBSTRING(SUBSTDelimCityName, 2, CHARINDEX(',', SubstringOne.SUBSTDelimCityName, 2) - 2) AS CityName		-- SubstringTwo5
    FROM (
	    SELECT SUBSTRING(Z.DelimListCityName, Iteration.Position, LEN(Z.DelimListCityName)) AS SUBSTDelimCityName	-- SubstringOne4
	    FROM 
		(	
		SELECT ',' + STRING_AGG (CONVERT(NVARCHAR(max),Y.City), CHAR(44)) + ',' AS DelimListCityName		-- DelimListCities3 = Z
		FROM	
			(
			SELECT DISTINCT X.City				-- UniqueCityName2 = Y
			    , X.CountryRegionCode
			FROM
				(
				SELECT 					-- OriginalTables1 = X
				PersonAddress.AddressID
				, PersonAddress.City
				, PersonAddress.StateProvinceID
				, StateID.StateProvinceCode
				, StateID.CountryRegionCode
				, StateID.TerritoryID
				, SalesTerritory.Name AS TerritoryName
				FROM [AdventureWorks2022].[Person].[Address] AS PersonAddress
				LEFT JOIN [AdventureWorks2022].[Person].[StateProvince] AS StateID
					ON PersonAddress.StateProvinceID = StateID.StateProvinceID
				LEFT JOIN [AdventureWorks2022].[Sales].[SalesTerritory] AS SalesTerritory
					ON StateID.TerritoryID = SalesTerritory.TerritoryID			-- OriginalTables1 = X
				) AS X										-- UniqueCityName2 = Y
			) AS Y	
			GROUP BY Y.CountryRegionCode					-- DelimitedListCities3 = Z 
			) AS Z,
			(
			SELECT ROW_NUMBER() OVER(ORDER BY AddressID) AS Position	-- Iteration3
			FROM [AdventureWorks2022].[Person].[Address]
			) AS Iteration							-- Iteration3
	    WHERE Iteration.Position <= LEN(Z.DelimListCityName)			-- SubstringOne4
	    ) AS SubstringOne
	WHERE LEN(SUBSTDelimCityName) > 1 AND SUBSTRING(SUBSTDelimCityName, 1, 1) = ','
    )
ORDER BY City


	-- OUTPUT
City		AddressLine1
Abingdon	New Millhouse, 2583 Milton Park
Albany		1619 Mills Dr.
Albany		2255 254th Avenue Se
Albany		9098 Story Lane
Albany		Heritage Mall
.......................................... TRUNCATED RESULTS .........
Berlin		8783 Detroit Ave.
Berlin		Alderstr 3955
.......................................... TRUNCATED RESULTS .........
London		1005 Valley Oak Plaza
London		1019 Mt. Davidson Court
.......................................... TRUNCATED RESULTS .........
 aNew York	123 Union Square South
New York	2596 Big Canyon Road
.......................................... TRUNCATED RESULTS .........
York		2050 B Avenue I
Zeeland		855 East Main Avenue
(19614 rows affected)
(end of results)



	Explanation for solution #1:
	---------------------------
We use multiple subqueries:
1) Subquery "X": uses tables from database [AdventureWorks2022]. 
For guidance we call it "OriginalTables1". This subquery is at Level 1.

2) Subquery "Y": removes duplicated City names from Subquery X using SELECT DISTINCT statement.
For guidance we call it "UniqueCityName2".
This subquery is at Level 2.

3) Subquery "Z": this query:
a) concatenates the DISTINCT City values FROM Subquery Y and groups them by CountryRegionCode, THEN, 
b) adds a comma before and after each DISTINCT City value from Subquery Y. 
It returns the same OUTPUT as in Exercise #4 (a total of 6 rows) with 1 comma before and after each delimited list.
This subquery is at Level 3.

4) Subquery "Iteration": this query:
Uses Window Function ROW_NUMBER() which returns a list of sequential numbers, starting at 1 for the first row in each partition, ending at 19,614.
19,614 is the number of rows in table [AdventureWorks2022].[Person].[Address].
This subquery is at Level 3.


5) Subquery SubstringOne: the function SUBSTRING (#1) extracts the delimited lists created by Subquery Z, and returns a total of 117,684 rows = 6 multiplied by 19,614.
117,684 rows = total number of delimited lists of City names separated by commas for each of the 6 CountryRegionCode.
6  = number of CountryRegionCodes = AU, CA, DE, FR, GB, US
19,614 = number of rows in table [AdventureWorks2022].[Person].[Address]
This subquery is at Level 4.

5.1) Cartesian Product:
The 117,684 rows resulted from the use of a Cartesian Product between Subquery Z and Subquery Iteration.
Cartesian Product: has a dimension of 6 X 19,614, meaning 117,684 rows.
Subquery Iteration: has a total of 19,614 rows.

5.2) WHERE clause and the iteration:
After adding the WHERE clause (WHERE Iteration.Position <= LEN(Z.DelimListCityName) at the end of Subquery SubstringOne, we reduce the OUTPUT from 117,684 rows to 5,657 rows.

5,657 rows = sum of the character length for the delimited lists of all 6 countries.

	CountryRegionCode	CharacterLengthDelimitedLists
	AU			421
	CA			449
	DE			356
	FR			378
	GB			359
	US			3694
	------------------------------
	Total			5,657


5.3) Function SUBSTRING and the iteration:
For each of the 5,657 rows, this function returns a string having 1 character less than the previous row each time that the iteration passes through each row.
For example, below we can see the values returned by this function for FirstName values for CountryRegionCode equals to AU and CA.

Row #	SUBSTDelimCityName								CharacterLengthDelimitedLists	CountryRegionCode
1	,Bendigo,Cloverdale,Port Macquarie,South Melbourne,.........,Wollongong,	421				AU
2	Bendigo,Cloverdale,Port Macquarie,South Melbourne,S.........,Wollongong,	421				AU
3	endigo,Cloverdale,Port Macquarie,South Melbourne,Sy.........,Wollongong,	421				AU
4	ndigo,Cloverdale,Port Macquarie,South Melbourne,Syd.........,Wollongong,	421				AU
5	digo,Cloverdale,Port Macquarie,South Melbourne,Sydn.........,Wollongong,	421				AU
6	igo,Cloverdale,Port Macquarie,South Melbourne,Sydne.........,Wollongong,	421				AU
7	go,Cloverdale,Port Macquarie,South Melbourne,Sydney.........,Wollongong,	421				AU
8	o,Cloverdale,Port Macquarie,South Melbourne,Sydney,.........,Wollongong,	421				AU
9	,Cloverdale,Port Macquarie,South Melbourne,Sydney,M.........,Wollongong,	421				AU
10	Cloverdale,Port Macquarie,South Melbourne,Sydney,Ma.........,Wollongong,	421				AU
11	loverdale,Port Macquarie,South Melbourne,Sydney,Mat.........,Wollongong,	421				AU
12	overdale,Port Macquarie,South Melbourne,Sydney,Matr.........,Wollongong,	421				AU
13	verdale,Port Macquarie,South Melbourne,Sydney,Matra.........,Wollongong,	421				AU
14	erdale,Port Macquarie,South Melbourne,Sydney,Matrav.........,Wollongong,	421				AU
15	rdale,Port Macquarie,South Melbourne,Sydney,Matravi.........,Wollongong,	421				AU
16	dale,Port Macquarie,South Melbourne,Sydney,Matravil.........,Wollongong,	421				AU
17	ale,Port Macquarie,South Melbourne,Sydney,Matravill.........,Wollongong,	421				AU
18	le,Port Macquarie,South Melbourne,Sydney,Matraville.........,Wollongong,	421				AU
19	e,Port Macquarie,South Melbourne,Sydney,Matraville,.........,Wollongong,	421				AU
....................................................... TRUNCATED RESULTS ...............................................................
410	,Wollongong,									421				AU
411	Wollongong,									421				AU
412	ollongong,									421				AU
413	llongong,									421				AU
414	longong,									421				AU
415	ongong,										421				AU
416	ngong,										421				AU
417	gong,										421				AU
418	ong,										421				AU
419	ng,										421				AU
420	g,										421				AU
421	,										421				AU
....................................................... TRUNCATED RESULTS ...............................................................
422	,Brampton,Quebec,Victoria,Montreal,Waterloo,Langley,.........,Chalk Riber,	449				CA	
423	Brampton,Quebec,Victoria,Montreal,Waterloo,Langley,.........,,Chalk Riber,	449				CA	
....................................................... TRUNCATED RESULTS ...............................................................
859	Chalk Riber,									449				CA
860	halk Riber,									449				CA
861	alk Riber,									449				CA
862	lk Riber,									449				CA
863	k Riber,									449				CA
864	 Riber,										449				CA
865	Riber,										449				CA
866	iber,										449				CA
867	ber,										449				CA
868	er,										449				CA
869	r,										449				CA
870	,										449				CA
....................................................... TRUNCATED RESULTS ...............................................................
(5657 rows affected)
(end of results)



6) Subquery "SubstringTwo": 
Function SUBSTRING (#2) uses its parameters #2 (start) and #3 (length) to extract a string starting at position 2 and ending at the position of the 2nd comma of the string. See below column "CityName"
This subquery is at Level 5.

The function is as follows: SUBSTRING(SUBSTDelimCityName, 2, CHARINDEX(',', SubstringOne.SUBSTDelimCityName, 2) - 2) AS CityName
Parameter #2 (start): starts extracting at position 2
Parameter #3 (length): number of characters to extract = CHARINDEX(',', SubstringOne.SUBSTDelimCityName, 2) - 2


Row #	SUBSTDelimCityName			osition2ndComma		LengthParam3	lenSUBSTDelimCityName	CityName
1	,Bendigo,Cloverdale,Port .....		9			7		421			Bendigo
2	Bendigo,Cloverdale,Port M.....		8			6		420			endigo	<--- Filtered out/WHERE
3	endigo,Cloverdale,Port Ma.....		7			5		419			ndigo	<--- Filtered out/WHERE
4	ndigo,Cloverdale,Port Mac.....		6			4		418			digo	<--- Filtered out/WHERE
5	digo,Cloverdale,Port Macq.....		5			3		417			igo	<--- Filtered out/WHERE
6	igo,Cloverdale,Port Macqu.....		4			2		416			go	<--- Filtered out/WHERE
7	go,Cloverdale,Port Macqua.....		3			1		415			o	<--- Filtered out/WHERE
8	o,Cloverdale,Port Macquar.....		2			0		414				<--- Filtered out/WHERE
9	,Cloverdale,Port Macquari.....		12			10		413			Cloverdale
10	Cloverdale,Port Macquarie.....		11			9		412			loverdale <- Filtered out/WHERE
11	loverdale,Port Macquarie,.....		10			8		411			overdale  <- Filtered out/WHERE
12	overdale,Port Macquarie,S.....		9			7		410			verdale	  <- Filtered out/WHERE
13	verdale,Port Macquarie,So.....		8			6		409			erdale	  <- Filtered out/WHERE
14	erdale,Port Macquarie,Sou.....		7			5		408			rdale	  <- Filtered out/WHERE
15	rdale,Port Macquarie,Sout.....		6			4		407			dale	  <- Filtered out/WHERE
16	dale,Port Macquarie,South.....		5			3		406			ale	  <- Filtered out/WHERE
17	ale,Port Macquarie,South .....		4			2		405			le	  <- Filtered out/WHERE
18	le,Port Macquarie,South M.....		3			1		404			e	  <- Filtered out/WHERE
19	e,Port Macquarie,South Me.....		2			0		403				  <- Filtered out/WHERE
20	,Port Macquarie,South Mel.....		16			14		402			Port Macquarie
....................................................... TRUNCATED RESULTS ...............................................................
(5657 rows affected)
(end of results)


6.1) WHERE clause: 
It is as follows: WHERE LEN(SUBSTDelimCityName) > 1 AND SUBSTRING(SUBSTDelimCityName, 1, 1) = ','
It keeps the rows from column "SUBSTDelimCityName" that (1) has more than 1 character and (2) the first character of the string is a comma.
In the above example, it keeps row 1, filters out rows from 2 up to 8, keeps row 9, filters out rows from 10 up to 19, etc.

Below we can see the output for Subquery SubstringTwo which returns a list of multiple values (each on a separate row) that can be passed to the IN clause and used in the WHERE clause.

	-- OUTPUT
CityName
Bendigo
Cloverdale
Port Macquarie
South Melbourne
Sydney
................ TRUNCATED RESULTS .......
(579 rows affected)
(end of results)
